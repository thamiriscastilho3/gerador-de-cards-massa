<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Card em Massa - Padr√£o Fixo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* ========================================================= */
        /* === ESTILOS GERAIS E DO FLUXO DE TRABALHO ================ */
        /* ========================================================= */
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f4f4f9; }
        .container-criacao { display: flex; gap: 40px; width: 90%; max-width: 1700px; margin-bottom: 40px; }
        #formulario-entrada { flex: 1; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); min-width: 400px; }
        input { display: block; width: 100%; margin-bottom: 15px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .download-btn, #download-template { border: none; cursor: pointer; font-size: 1.2em; padding: 10px; border-radius: 4px; margin-bottom: 15px; text-decoration: none; display: block; width: 100%; text-align: center; }
        .download-btn { background-color: #2ECC71; color: white; }
        .download-btn:hover { background-color: #27AE60; }
        #download-template { background-color: #3498DB; color: white; }
        #download-template:hover { background-color: #2980B9; }
        .step { display: none; }
        .step.active { display: block; }
        #data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #data-table th, #data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.8em; }
        #data-table th { background-color: #f2f2f2; }
        .image-cell input[type="file"] { width: auto; display: inline; }
        .status-cell { font-weight: bold; }
        
        /* Estilo para a nova ferramenta de zoom */
        .zoom-controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; justify-content: center; }
        .zoom-controls button { padding: 8px 15px; background-color: #ccc; border: none; cursor: pointer; }
        .zoom-controls button:hover { background-color: #aaa; }

        /* ========================================================= */
        /* === NOVO ESTILO DO CARD (BASEADO NA IMAGEM FIXA) ========== */
        /* ========================================================= */
        #card-preview {
            width: 600px; 
            height: 1066px; 
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            position: relative; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            display: block; 

            /* FUNDO PADR√ÉO */
            background-image: url('./assets/background-card.png'); 
            background-size: cover;
            background-position: center;
            background-color: #000; 
        }

        /* 1. T√çTULO DO CARD (Cor e posi√ß√£o mantidas do seu c√≥digo) */
        #card-titulo {
            position: absolute;
            top: 120px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            text-align: center;
            color: #ffffff; 
            font-size: 2.0em;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
            z-index: 20;
            white-space: normal;
            word-wrap: break-word;
        }

        /* 2. √ÅREA DOS PRE√áOS (Canto superior direito) */
        .precos-container {
            position: absolute;
            top: 235px; 
            right: 70px; 
            text-align: right;
            z-index: 20;
            line-height: 1.1;
            font-family: sans-serif;
            font-weight: 700;
        }

        #label-compre-por, #label-venda-por {
            font-size: 1em;
            font-weight: 400;
            color: #4a4a4a;
            margin: 0;
            display: block;
        }

        /* Base para os valores: usa Flexbox para alinhar as partes do pre√ßo */
        #valor-compre-por, #valor-venda-por {
            display: flex;
            justify-content: flex-end; 
            align-items: flex-end; 
            font-weight: 900;
            color: #ffffff; 
            line-height: 1; 
            margin: 0;
        }

        #valor-compre-por {
            font-size: 3.5em; 
            margin-bottom: 15px;
        }

        #valor-venda-por {
            font-size: 2.5em; 
        }
        
        /* R$ e Centavos (Tamanho menor, alinhados √† base) */
        .valor-moeda, .valor-centavos {
            font-size: 0.45em; 
            align-self: flex-end; 
            padding-bottom: 0.1em; 
            font-weight: 700;
            margin-left: 2px;
        }

        /* O valor-reais (n√∫mero antes da v√≠rgula) usa o tamanho base (1em) */
        .valor-reais {
            font-size: 1em; 
            line-height: 1;
        }

        /* 3. IMAGEM DO PRODUTO (Posi√ß√£o mantida do seu c√≥digo) */
        #card-imagem-area {
            position: absolute;
            top: 350px; 
            left: 50%;
            transform: translateX(-50%);
            width: 70%; 
            height: 500px; 
            z-index: 10; 
            overflow: hidden;
        }

        #card-imagem {
            width: 100%; 
            height: 100%; 
            background-color: transparent; 
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center;
        }

        /* 4. SKU E NOME DO SKU (Cor e posi√ß√£o mantidas do seu c√≥digo) */
        #card-info-produto {
            position: absolute;
            bottom: 170px; 
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            text-align: center;
            background-color: #ab2427; 
            padding: 10px 20px;
            border-radius: 0px;
            z-index: 20;
        }

        /* üö® ALTERA√á√ÉO SOLICITADA */
        #card-sku {
            font-size: 1.0em; /* Alterado de 1.2em */
            font-weight: 400; 
            color: #ffffff; 
            margin: 0; 
        }
        
        /* üö® ALTERA√á√ÉO SOLICITADA */
        #card-nome-produto {
            font-size: 0.7em; /* Alterado de 1.5em */
            font-weight: 700; 
            color: #ffffff; 
            margin: 0; 
            line-height: 1.2;
            white-space: normal;
            word-wrap: break-word;
        }

        /* Removemos elementos n√£o utilizados no novo design */
        #card-subtitulo, #card-valor-overlay, #card-footer-legal, 
        #card-titulo-container {
            display: none !important;
        }
    </style>
</head>
<body>

    <h1>Gerador de Cards de Produto - Padr√£o de Marca Fixo</h1>

    <div class="container-criacao">
        
        <div id="formulario-entrada">

            <div id="step-1" class="step active">
                <h2>1. Upload da Planilha de Dados</h2>
                
                <p>O design do Card est√° fixo na imagem de fundo. Voc√™ precisa apenas das informa√ß√µes mut√°veis na planilha.</p>

                <p>Use o Google Planilhas para preencher sua base de dados. Siga os passos:</p>
                
                <ol style="text-align: left; padding-left: 20px; font-size: 0.9em;">
                    <li>Clique no link abaixo para criar uma **c√≥pia** do modelo.</li>
                    <li>Preencha os dados e fa√ßa o download como **CSV**.</li>
                </ol>
                
                <a id="download-template" 
                    href="https://docs.google.com/spreadsheets/d/1imdU6xCTMruDmqk8ds019uIfiNa97jJhQqjFc-GF5Gc/copy" 
                    target="_blank" 
                    onclick="alert('Lembre-se de fazer o download do arquivo no formato CSV ap√≥s o preenchimento na Planilha Google!')">
                    Abrir Modelo no Google Planilhas
                </a>

                <label for="input-csv">Selecione o arquivo CSV baixado (.csv):</label>
                <input type="file" id="input-csv" accept=".csv, text/csv">
                
                <button onclick="processarPlanilha()">Processar Dados da Planilha</button>
            </div>

            <div id="step-2" class="step">
                <h2>2. Anexar Imagens por Produto</h2>
                <p>Carregue a imagem para cada card (Opcional). A Pr√©via e o Download est√£o sempre ativos.</p>
                
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>T√≠tulo</th>
                            <th>Vl. Original</th>
                            <th>Vl. Venda</th>
                            <th>SKU</th>
                            <th>Imagem</th>
                            <th>Status</th>
                            <th>Pr√©via</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <button onclick="gerarTodosCards()" class="download-btn">
                    Gerar e Baixar TODOS os Cards (Arquivo ZIP)
                </button>
                <button onclick="irParaPasso(1)">Voltar para Upload</button>
            </div>

            <div id="step-3" class="step">
                <h2>3. Pr√©-visualiza√ß√£o Individual</h2>
                <p>Use o zoom para ajustar a imagem do produto no espa√ßo preto.</p>
                
                <div class="zoom-controls">
                    <button onclick="ajustarZoom(-0.05)">Zoom -</button>
                    <button onclick="ajustarZoom(0.05)">Zoom +</button>
                    <button onclick="resetarZoom()">Resetar</button>
                </div>

                <button onclick="gerarCardIndividual()" class="download-btn">Baixar Este Card</button>
                <button onclick="voltarParaTabela()">Voltar para a Lista</button>
            </div>

        </div>

        <div id="card-preview">
            
            <p id="card-titulo">T√çTULO DO CARD</p>

            <div id="card-imagem-area">
                <div id="card-imagem"></div>
            </div>
            
            <div class="precos-container">
                <span id="label-compre-por">COMPRE POR</span>
                <span id="valor-compre-por">000,00</span>
                
                <span id="label-venda-por">VENDA POR</span>
                <span id="valor-venda-por">000,00</span>
            </div>

            <div id="card-info-produto">
                <p id="card-sku">SKU</p>
                <p id="card-nome-produto">NOME DO SKU</p>
            </div>
            
            <div id="card-titulo-container"></div>
            <div id="card-valor-overlay"></div>
            <div id="card-footer-legal"></div>

        </div>
    </div>
    
    <script>
        // ==============================================
        // JAVASCRIPT: L√ìGICA DE CRIA√á√ÉO EM MASSA
        // ==============================================

        let dadosPlanilha = []; 
        let cardAtualIndex = -1; 
        let currentZoom = 1.0; 

        // FUN√á√ÉO DE RENDERIZA√á√ÉO DE VALOR
        const renderizarValorFormatado = (elementoId, valorString) => {
            const elemento = document.getElementById(elementoId);
            
            const valorTratado = String(valorString).replace('R$', '').replace('.', '').replace(',', '.').trim();
            const num = parseFloat(valorTratado);
            
            if (isNaN(num)) {
                elemento.innerHTML = `<span class="valor-moeda">R$</span><span class="valor-reais">0</span><span class="valor-centavos">,00</span>`;
                return;
            }

            const valorFormatado = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            const valorSemMoeda = valorFormatado.replace('R$', '').trim();
            const partes = valorSemMoeda.split(',');
            const reais = partes[0] || '0';
            const centavos = partes[1] || '00';
            
            elemento.innerHTML = `
                <span class="valor-moeda">R$</span>
                <span class="valor-reais">${reais}</span>
                <span class="valor-centavos">,${centavos}</span>
            `;
        };
        
        // --- FUN√á√ïES DE ZOOM ---
        const aplicarZoom = () => {
            const imgDiv = document.getElementById('card-imagem');
            imgDiv.style.backgroundSize = `${currentZoom * 100}%`;
        };

        const ajustarZoom = (fator) => {
            currentZoom = Math.min(2.0, Math.max(1.0, currentZoom + fator)); 
            aplicarZoom();
        };

        const resetarZoom = () => {
            currentZoom = 1.0;
            aplicarZoom();
        };

        // --- FUN√á√ïES DE FLUXO E MALA DIRETA ---
        
        const irParaPasso = (stepNum) => {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${stepNum}`).classList.add('active');
            
            if (stepNum === 3) {
                resetarZoom();
                const idToPreview = cardAtualIndex !== -1 ? cardAtualIndex : (dadosPlanilha[0] ? dadosPlanilha[0].id : -1);
                if (idToPreview !== -1) atualizarCardPreview(idToPreview); 
            } else if (stepNum === 2 && dadosPlanilha.length > 0) {
                 const idToPreview = cardAtualIndex !== -1 ? cardAtualIndex : dadosPlanilha[0].id;
                 atualizarCardPreview(idToPreview); 
            }
        };
        
        const formatarValorTabela = (valor) => {
            const num = parseFloat(String(valor).replace('R$', '').replace('.', '').replace(',', '.').trim());
            if (isNaN(num)) return 'R$ 0,00';
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        
        // üö® FUN√á√ÉO PARA GERAR A IMAGEM COMO DATAURL
        const gerarCardData = async (produto) => {
             const SCALE_FACTOR = 1.8;
             
             atualizarCardPreview(produto.id);
             
             const imgDiv = document.getElementById('card-imagem');
             const originalSize = imgDiv.style.backgroundSize;
             const originalPosition = imgDiv.style.backgroundPosition;

             if (originalSize) {
                 imgDiv.style.backgroundSize = originalSize;
             } else {
                 imgDiv.style.backgroundSize = 'cover';
             }
             if (originalPosition) {
                 imgDiv.style.backgroundPosition = originalPosition;
             } else {
                 imgDiv.style.backgroundPosition = 'center';
             }
             
             await new Promise(resolve => setTimeout(resolve, 50)); 
             
             document.body.style.margin = '0'; 
             document.body.style.padding = '0';
             
             const canvas = await html2canvas(document.getElementById('card-preview'), { 
                 scale: SCALE_FACTOR,
                 useCORS: true,
                 x: 0,
                 y: 0,
             });
                 
             document.body.style.margin = '';
             document.body.style.padding = '';

             // Restaura os estilos
             imgDiv.style.backgroundSize = originalSize;
             imgDiv.style.backgroundPosition = originalPosition;

             // Retorna a URL Base64
             return canvas.toDataURL('image/png');
        };

        // FUN√á√ÉO DE DOWNLOAD INDIVIDUAL (mantida para facilitar o download de 1 item)
        const gerarCardIndividual = async () => {
             if (cardAtualIndex === -1) {
                 alert("Por favor, selecione um card na lista antes de tentar baixar.");
                 return;
             }
             
             const produto = dadosPlanilha.find(p => p.id === cardAtualIndex);
             const dataURL = await gerarCardData(produto); // Obt√©m os dados

             const link = document.createElement('a');
             const tituloLimpo = (produto['T√≠tulo Principal'] || 'card').replace(/\s+/g, '-').replace(/[^\w-]/g, '');
             const skuLimpo = (produto['SKU'] || 'sem-sku').replace(/\s+/g, '-').replace(/[^\w-]/g, '');
             
             link.download = `${tituloLimpo}-${skuLimpo}-600x1066.png`;
             link.href = dataURL;
             link.click();

             document.getElementById(`status-${produto.id}`).innerText = 'Card Gerado';
        };

        // üö® FUN√á√ÉO PARA GERAR O ZIP
        const gerarTodosCards = async () => {
            const cardsParaGerar = dadosPlanilha;
            
            if (cardsParaGerar.length === 0) {
                alert("A planilha est√° vazia ou n√£o foi processada.");
                return;
            }

            const downloadBtn = document.querySelector('.download-btn');
            const originalText = downloadBtn.innerText;
            downloadBtn.innerText = 'Processando e Zipando... N√£o feche a janela!';
            downloadBtn.disabled = true;

            const zip = new JSZip();
            const pasta = zip.folder("cards-gerados");
            
            for (const produto of cardsParaGerar) {
                try {
                    // 1. Gera os dados da imagem
                    const dataURL = await gerarCardData(produto);
                    
                    // 2. Limpa o nome do arquivo
                    const tituloLimpo = (produto['T√≠tulo Principal'] || 'card').replace(/\s+/g, '-').replace(/[^\w-]/g, '');
                    const skuLimpo = (produto['SKU'] || 'sem-sku').replace(/\s+/g, '-').replace(/[^\w-]/g, '');
                    const nomeArquivo = `${tituloLimpo}-${skuLimpo}-600x1066.png`;

                    // 3. Converte DataURL para Base64 puro e adiciona ao ZIP
                    const base64Data = dataURL.replace(/^data:image\/(png|jpeg);base64,/, "");
                    pasta.file(nomeArquivo, base64Data, {base64: true});

                    document.getElementById(`status-${produto.id}`).innerText = 'Adicionado ao ZIP';
                    
                } catch (e) {
                    console.error(`Falha ao gerar o card para ${produto['T√≠tulo Principal']}:`, e);
                    document.getElementById(`status-${produto.id}`).innerText = 'ERRO';
                }
            }

            // 4. Gera o arquivo ZIP
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                // 5. Usa FileSaver.js para iniciar o download √∫nico
                saveAs(content, "cards_em_massa.zip");
                alert("Gera√ß√£o em massa conclu√≠da! Seu download ZIP deve ter iniciado.");
            })
            .finally(() => {
                downloadBtn.innerText = originalText;
                downloadBtn.disabled = false;
            });
        };


        const processarPlanilha = () => {
            const file = document.getElementById('input-csv').files[0];
            if (!file) { alert("Por favor, selecione um arquivo CSV."); return; }

            Papa.parse(file, {
                header: true, 
                dynamicTyping: false,
                skipEmptyLines: true,
                delimiter: "", 
                worker: true,
                
                complete: function(results) {
                    if (results.errors.length > 0) { console.error(results.errors); alert("Erro na leitura do CSV."); return; }
                    if (results.data.length === 0) { alert("A planilha est√° vazia."); return; }
                    
                    const requiredHeaders = ["T√≠tulo Principal", "Valor Original", "Valor de Venda", "Nome do Produto", "SKU"];
                    const actualHeaders = results.meta.fields || [];

                    const missingHeaders = requiredHeaders.filter(header => !actualHeaders.includes(header));

                    if (missingHeaders.length > 0) { alert(`‚ö†Ô∏è Erro de Cabe√ßalho: Os seguintes t√≠tulos de coluna est√£o faltando ou incorretos na primeira linha: ${missingHeaders.join(', ')}. Por favor, use o modelo exato.`); return; }

                    dadosPlanilha = results.data.map((item, index) => ({
                        id: index,
                        'T√≠tulo Principal': item['T√≠tulo Principal'] || '',
                        'Valor Original': item['Valor Original'] || '0', 
                        'Valor de Venda': item['Valor de Venda'] || '0',
                        'Nome do Produto': item['Nome do Produto'] || '',
                        'SKU': item['SKU'] || '',
                        imagem: null, 
                        status: 'Pronto para Visualizar', 
                        cardGerado: false
                    })).filter(item => item['T√≠tulo Principal'] !== null && item['T√≠tulo Principal'] !== ''); 
                    
                    if (dadosPlanilha.length === 0) { alert("Nenhuma linha de dados v√°lida encontrada ap√≥s a filtragem."); return; }

                    montarTabelaDeDados();
                    irParaPasso(2); 
                },
                error: function(error) { alert("Erro fatal ao processar o arquivo CSV: " + error.message); }
            });
        };

        const montarTabelaDeDados = () => {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = ''; 
            
            dadosPlanilha.forEach((produto, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${produto['T√≠tulo Principal'] || ''}</td>
                    <td>${formatarValorTabela(produto['Valor Original'])}</td>
                    <td>${formatarValorTabela(produto['Valor de Venda'])}</td>
                    <td>${produto['SKU'] || ''}</td>
                    <td class="image-cell">
                        <input type="file" accept="image/png, image/jpeg" 
                               id="file-${index}" 
                               onchange="carregarImagemMassa(event, ${index})">
                    </td>
                    <td class="status-cell" id="status-${index}">${produto.status}</td>
                    <td>
                        <button onclick="irParaVisualizacao(${index})">
                            Pr√©via
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        const carregarImagemMassa = (event, index) => {
            const arquivo = event.target.files[0];
            const statusCell = document.getElementById(`status-${index}`);

            if (arquivo) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    dadosPlanilha[index].imagem = e.target.result;
                    dadosPlanilha[index].status = 'Imagem Carregada';
                    statusCell.innerText = 'Imagem Carregada';
                    
                    if (document.getElementById('step-3').classList.contains('active') && cardAtualIndex === index) {
                         atualizarCardPreview(index);
                    }
                };
                reader.readAsDataURL(arquivo);
            }
        };

        const atualizarCardPreview = (id) => {
            cardAtualIndex = id;
            const produto = dadosPlanilha.find(p => p.id === id); 
            if (!produto) return;

            document.getElementById('card-titulo').innerText = produto['T√≠tulo Principal'] || 'T√çTULO DO CARD';
            renderizarValorFormatado('valor-compre-por', produto['Valor Original']);
            renderizarValorFormatado('valor-venda-por', produto['Valor de Venda']);
            document.getElementById('card-nome-produto').innerText = produto['Nome do Produto'] || 'NOME DO SKU';
            document.getElementById('card-sku').innerText = produto['SKU'] || 'SKU';
            
            const cardImagemDiv = document.getElementById('card-imagem');
            cardImagemDiv.style.backgroundImage = produto.imagem ? `url('${produto.imagem}')` : 'none';
        };
        
        const irParaVisualizacao = (index) => {
            atualizarCardPreview(index);
            irParaPasso(3);
        };
        
        const voltarParaTabela = () => {
            irParaPasso(2);
        };

        document.getElementById('input-csv').addEventListener('change', processarPlanilha);

    </script>
</body>
</html>

