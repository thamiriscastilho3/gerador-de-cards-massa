<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GERADOR DE CARDS VIPS (PILOTO - TIME ANGELA) </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --cor-boticario: #00a775; --bg-painel: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }
        
        #controls { width: 550px; background: var(--bg-painel); border-right: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.05); z-index: 100; }
        .header-controls { padding: 15px 20px; border-bottom: 1px solid #eee; background: #fafafa; }
        .scroll-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        #preview-area { flex: 1; display: flex; justify-content: center; align-items: center; background: #444; overflow: auto; position: relative; }
        #render-wrap { position: relative; width: 1080px; height: 1350px; flex-shrink: 0; transform-origin: center center; }

        #card-canvas {
            width: 1080px; height: 1350px; position: relative;
            background-image: url('https://raw.githubusercontent.com/thamiriscastilho3/gerador-de-cards-massa/main/assets/background-card.png.png');
            background-size: 100% 100%; background-position: center; overflow: hidden; background-color: #000;
        }

        #header-area { position: absolute; top: 120px; left: 0; width: 100%; text-align: center; color: white; z-index: 10; pointer-events: none; }
        #titulo-principal { font-size: 60px; font-weight: 900; margin: 0; text-transform: uppercase; line-height: 1; }
        #subtitulo { font-size: 32px; font-weight: 300; margin: 10px 0; }
        
        #produto-img-container { position: absolute; top: 350px; left: 50%; transform: translateX(-50%); width: 750px; height: 750px; display: flex; align-items: center; justify-content: center; z-index: 5; }
        #produto-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        #bloco-informativo { 
            position: absolute; top: 50%; right: 80px; transform: translateY(-50%); 
            background-color: #00a775; color: white; padding: 40px; border-radius: 20px; width: 400px; z-index: 20;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #display-compre { font-size: 85px; font-weight: 900; line-height: 1; }
        #display-compre span { font-size: 35px; vertical-align: top; margin-right: 5px; }
        #display-venda { font-size: 28px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 20px; margin-bottom: 20px; }
        #info-detalhes { font-size: 20px; font-weight: 700; text-transform: uppercase; }
        #texto-legal { position: absolute; bottom: 40px; left: 100px; right: 100px; font-size: 18px; color: #fff; text-align: center; line-height: 1.2; z-index: 30; }

        .step { display: none; }
        .step.active { display: block; }
        .edit-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        .edit-group h4 { margin: 0 0 10px 0; font-size: 13px; color: var(--cor-boticario); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .control-row { margin-bottom: 10px; font-size: 12px; font-weight: bold; color: #444; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-primary { background: var(--cor-boticario); color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; table-layout: fixed; }
        th { text-align: left; background: #eee; padding: 8px; }
        td { padding: 10px 5px; border-bottom: 1px solid #eee; overflow: hidden; }
        .badge-memory { background: #e67e22; color: white; padding: 2px 5px; border-radius: 4px; font-size: 9px; display: inline-block; margin-top: 4px; }
        .url-input { width: 90%; font-size: 11px; padding: 5px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .file-input { font-size: 10px; width: 100%; }
    </style>
</head>
<body>

    <div id="controls">
        <div class="header-controls">
            <h2 style="margin:0; color:var(--cor-boticario);">Gerador Pr√≥ Ciclo 2</h2>
            <button onclick="limparMemoria()" style="font-size: 11px; color: red; background: none; border: none; cursor: pointer; text-decoration: underline;">Limpar Mem√≥ria de Imagens</button>
        </div>
        
        <div class="scroll-content">
            <div id="step-1" class="step active">
                <p>1. Selecione sua Planilha CSV:</p>
                <input type="file" id="csv-file" accept=".csv">
            </div>

            <div id="step-2" class="step">
                <div class="edit-group">
                    <h4>Exporta√ß√£o</h4>
                    <select id="export-format" style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px;">
                        <option value="png">Imagens Individuais (ZIP)</option>
                        <option value="pdf">PDF √önico</option>
                    </select>
                    <button class="btn btn-primary" id="btn-download" onclick="baixarArquivos()">GERAR E BAIXAR TUDO</button>
                    <button class="btn" style="background:#f0f0f0;" onclick="location.reload()">Trocar Planilha</button>
                </div>

                <div class="edit-group">
                    <h4>Design do T√≠tulo & Subt√≠tulo</h4>
                    <div class="control-row">Altura T√≠tulo (Y): <input type="range" id="posY-titulo" min="10" max="600" value="120" oninput="aplicarAjustes()"></div>
                    <div class="control-row">Tamanho T√≠tulo: <input type="range" id="size-titulo" min="20" max="150" value="60" oninput="aplicarAjustes()"></div>
                    <div class="control-row">Tamanho Subt√≠tulo: <input type="range" id="size-subtitulo" min="10" max="80" value="32" oninput="aplicarAjustes()"></div>
                </div>

                <div class="edit-group" style="background: #fff8f0; border: 1px solid #e67e22;">
                    <h4 style="color:#e67e22">Ajuste de Imagem (Individual)</h4>
                    <div class="control-row">Zoom: <input type="range" id="zoom-img" min="0.1" max="4" step="0.05" value="1" oninput="aplicarAjustes()"></div>
                    <div class="control-row">X: <input type="range" id="posX-img" min="-600" max="600" value="0" oninput="aplicarAjustes()"></div>
                    <div class="control-row">Y: <input type="range" id="posY-img" min="-600" max="600" value="0" oninput="aplicarAjustes()"></div>
                </div>

                <div class="edit-group">
                    <h4>Ajuste do Bloco de Pre√ßo</h4>
                    <div class="control-row">Posi√ß√£o X: <input type="range" id="posX-bloco" min="-600" max="100" value="0" oninput="aplicarAjustes()"></div>
                    <div class="control-row">Posi√ß√£o Y: <input type="range" id="posY-bloco" min="-400" max="400" value="0" oninput="aplicarAjustes()"></div>
                </div>

                <table id="data-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">SKU</th>
                            <th style="width: 60%;">Foto / Link</th>
                            <th style="width: 15%;">Ver</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="preview-area">
        <div id="render-wrap" style="transform: scale(0.35);">
            <div id="card-canvas">
                <div id="header-area">
                    <p id="titulo-principal"></p>
                    <p id="subtitulo"></p>
                </div>
                <div id="produto-img-container"><img id="produto-img" crossOrigin="anonymous" src=""></div>
                <div id="bloco-informativo">
                    <div style="font-size: 20px; font-weight: bold;">COMPRE POR:</div>
                    <div id="display-compre"><span>R$</span>00,00</div>
                    <div id="display-venda"></div>
                    <div id="info-detalhes"><span id="display-sku"></span> | <span id="display-nome"></span></div>
                </div>
                <div id="texto-legal"></div>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let planilha = [];
        let currentCardIndex = 0;
        let memoriaSKU = JSON.parse(localStorage.getItem('banco_imagens_sku') || '{}');

        document.getElementById('csv-file').addEventListener('change', function(e) {
            Papa.parse(e.target.files[0], {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    planilha = results.data.map(item => {
                        const sku = (item['SKU'] || '').toString().trim();
                        return {
                            ...item,
                            imgData: memoriaSKU[sku] || '',
                            zoom: 1, posX: 0, posY: 0,
                            fromMemory: !!memoriaSKU[sku]
                        };
                    });
                    renderTabela();
                    document.getElementById('step-1').classList.remove('active');
                    document.getElementById('step-2').classList.add('active');
                    atualizarCard(0);
                }
            });
        });

        function renderTabela() {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            planilha.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${row['SKU']}</b>${row.fromMemory ? '<br><span class="badge-memory">Na Mem√≥ria</span>' : ''}</td>
                    <td>
                        <input type="file" class="file-input" onchange="carregarArquivo(event, ${index})">
                        <input type="text" class="url-input" placeholder="Ou cole link da imagem" onchange="carregarURL(this.value, ${index})">
                    </td>
                    <td><button style="cursor:pointer" onclick="atualizarCard(${index})">üëÅÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function carregarArquivo(event, index) {
            const reader = new FileReader();
            reader.onload = (e) => { 
                const data = e.target.result;
                planilha[index].imgData = data;
                salvarNaMemoria(planilha[index]['SKU'], data);
                atualizarCard(index); 
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        function carregarURL(url, index) {
            if(url.trim()){ 
                planilha[index].imgData = url.trim();
                salvarNaMemoria(planilha[index]['SKU'], url.trim());
                atualizarCard(index); 
            }
        }

        function salvarNaMemoria(sku, data) {
            if(!sku) return;
            memoriaSKU[sku.toString().trim()] = data;
            localStorage.setItem('banco_imagens_sku', JSON.stringify(memoriaSKU));
        }

        function atualizarCard(index) {
            currentCardIndex = index;
            const item = planilha[index];
            
            document.getElementById('titulo-principal').innerText = item['T√≠tulo Principal'] || '';
            document.getElementById('subtitulo').innerText = item['SUBT√çTULO'] || '';
            document.getElementById('display-compre').innerHTML = `<span>R$</span>${(item['COMPRE POR'] || '0,00').replace('R$', '').trim()}`;
            document.getElementById('display-venda').innerText = `Venda por: ${item['VENDA POR'] || ''}`;
            document.getElementById('display-sku').innerText = item['SKU'] || '';
            document.getElementById('display-nome').innerText = item['Nome do Produto'] || '';
            document.getElementById('texto-legal').innerText = item['(TEXTO LEGAL) Colocar no rodap√©'] || '';

            document.getElementById('zoom-img').value = item.zoom;
            document.getElementById('posX-img').value = item.posX;
            document.getElementById('posY-img').value = item.posY;

            const img = document.getElementById('produto-img');
            img.src = item.imgData || '';
            img.style.display = item.imgData ? 'block' : 'none';
            
            aplicarAjustes(false);
        }

        function aplicarAjustes(salvar = true) {
            const item = planilha[currentCardIndex];
            if(!item) return;

            if (salvar) {
                item.zoom = document.getElementById('zoom-img').value;
                item.posX = document.getElementById('posX-img').value;
                item.posY = document.getElementById('posY-img').value;
            }

            document.getElementById('header-area').style.top = document.getElementById('posY-titulo').value + "px";
            document.getElementById('titulo-principal').style.fontSize = document.getElementById('size-titulo').value + "px";
            document.getElementById('subtitulo').style.fontSize = document.getElementById('size-subtitulo').value + "px";
            
            document.getElementById('produto-img').style.transform = `scale(${item.zoom}) translate(${item.posX}px, ${item.posY}px)`;
            
            const bx = document.getElementById('posX-bloco').value;
            const by = document.getElementById('posY-bloco').value;
            document.getElementById('bloco-informativo').style.transform = `translate(${bx}px, calc(-50% + ${by}px))`;
        }

        function limparMemoria() {
            if(confirm("Apagar todas as imagens salvas pelo SKU?")) {
                localStorage.removeItem('banco_imagens_sku');
                location.reload();
            }
        }

        async function baixarArquivos() {
            const format = document.getElementById('export-format').value;
            const btn = document.getElementById('btn-download');
            btn.innerText = "‚è≥ GERANDO..."; btn.disabled = true;

            const wrap = document.getElementById('render-wrap');
            const originalTransform = wrap.style.transform;
            wrap.style.transform = "none"; 

            let pdf; let zip;
            if (format === 'pdf') pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [1080, 1350] });
            else zip = new JSZip();

            for (let i = 0; i < planilha.length; i++) {
                atualizarCard(i);
                await new Promise(r => setTimeout(r, 700)); 
                const canvas = await html2canvas(document.getElementById('card-canvas'), { scale: 1, useCORS: true, width: 1080, height: 1350 });
                
                if (format === 'pdf') {
                    const imgData = canvas.toDataURL("image/jpeg", 0.95);
                    if (i > 0) pdf.addPage([1080, 1350], 'p');
                    pdf.addImage(imgData, 'JPEG', 0, 0, 1080, 1350);
                } else {
                    const imgData = canvas.toDataURL("image/png").split(',')[1];
                    zip.file(`card_${planilha[i].SKU || i}.png`, imgData, {base64: true});
                }
            }

            wrap.style.transform = originalTransform;
            if (format === 'pdf') pdf.save("Cards_Final.pdf");
            else {
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "Cards_Final.zip");
            }
            btn.innerText = "GERAR E BAIXAR TUDO"; btn.disabled = false;
        }
    </script>
</body>
</html>
