<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Cards - Layout Otimizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { --cor-boticario: #00a775; --bg-painel: #ffffff; }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; 
            background: #f0f2f5; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; /* Impede a rolagem do corpo principal */
        }

        /* PAINEL DE CONTROLE ESQUERDO */
        #controls { 
            width: 400px; 
            background: var(--bg-painel); 
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .header-controls { padding: 20px; border-bottom: 1px solid #eee; }
        .scroll-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            scrollbar-width: thin;
        }

        /* √ÅREA DE VISUALIZA√á√ÉO DO CARD */
        #preview-area { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding: 40px; 
            overflow-y: auto; /* Rolagem apenas no card se necess√°rio */
            background: #e4e6e9;
        }

        /* CARD CONFIG (1080x1350) - Escala de 0.5x para caber na tela */
        #card-canvas {
            width: 540px; 
            height: 675px;
            position: relative;
            background-image: url('https://raw.githubusercontent.com/thamiriscastilho3/gerador-de-cards-massa/main/assets/background-card.png.png');
            background-size: 100% 100%;
            overflow: hidden; 
            flex-shrink: 0; 
            background-color: #000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        /* Elementos Internos do Card */
        #header-area { position: absolute; top: 40px; left: 0; width: 100%; text-align: center; color: white; z-index: 10; }
        #titulo-principal { font-size: 26px; font-weight: 900; margin: 0; text-transform: uppercase; }
        #subtitulo { font-size: 14px; font-weight: 300; margin: 2px 0; }

        #produto-img-container {
            position: absolute; top: 150px; left: 20px;
            width: 350px; height: 400px;
            display: flex; align-items: center; justify-content: center; z-index: 5;
        }
        #produto-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        #bloco-informativo {
            position: absolute; top: 50%; right: 25px; transform: translateY(-50%);
            background-color: var(--cor-boticario); color: white;
            padding: 15px; border-radius: 8px; width: 185px; z-index: 20;
        }
        #display-compre { font-size: 34px; font-weight: 900; line-height: 1; }
        #display-compre span { font-size: 16px; vertical-align: top; }
        #display-venda { font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 8px; margin-bottom: 8px; }
        #info-detalhes { font-size: 9px; font-weight: 700; text-transform: uppercase; }
        #texto-legal { position: absolute; bottom: 15px; left: 40px; right: 40px; font-size: 7.5px; color: #fff; text-align: center; line-height: 1.2; text-shadow: 1px 1px 2px #000;}

        /* Estiliza√ß√£o da UI */
        .step { display: none; }
        .step.active { display: block; }
        .edit-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eef0f2; }
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; font-weight: 600; color: #444; }
        input[type="range"] { flex: 1; accent-color: var(--cor-boticario); }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-primary { background: var(--cor-boticario); color: white; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #eee; padding: 6px; text-align: left; }
        .input-text-url { width: 100%; font-size: 10px; margin-bottom: 5px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="controls">
        <div class="header-controls">
            <h2 style="margin:0; color:var(--cor-boticario); font-size: 1.2rem;">Gerador de Cards Massa</h2>
        </div>

        <div class="scroll-content">
            <div id="step-1" class="step active">
                <p>Para come√ßar, suba sua planilha CSV:</p>
                <input type="file" id="csv-file" accept=".csv" style="width: 100%;">
            </div>

            <div id="step-2" class="step">
                <button class="btn btn-primary" onclick="baixarZip()">BAIXAR TODOS (.ZIP)</button>
                <button class="btn" style="background:#eee;" onclick="location.reload()">REINICIAR</button>
                
                <div class="edit-group">
                    <h4 style="margin-top:0;">Ajustes da Imagem</h4>
                    <div class="control-row">Zoom: <input type="range" id="zoom-img" min="0.4" max="2.5" step="0.1" value="1" oninput="aplicarAjustes()"></div>
                    <div class="control-row">Eixo X: <input type="range" id="posX-img" min="-200" max="200" step="1" value="0" oninput="aplicarAjustes()"></div>
                    <div class="control-row">Eixo Y: <input type="range" id="posY-img" min="-200" max="200" step="1" value="0" oninput="aplicarAjustes()"></div>
                </div>

                <div class="edit-group">
                    <h4 style="margin-top:0;">Ajustes de Texto</h4>
                    <div class="control-row">T√≠tulo (Y): <input type="range" id="posY-titulo" min="10" max="200" step="1" value="40" oninput="aplicarAjustes()"></div>
                </div>

                <h4 style="font-size: 12px; color: #666;">Lista de Produtos</h4>
                <table id="data-table">
                    <thead><tr><th>SKU</th><th>Imagem (URL ou Arq)</th><th>Ver</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="preview-area">
        <div id="card-canvas">
            <div id="header-area">
                <p id="titulo-principal">T√çTULO</p>
                <p id="subtitulo">SUBT√çTULO</p>
            </div>
            <div id="produto-img-container"><img id="produto-img" crossOrigin="anonymous" src=""></div>
            <div id="bloco-informativo">
                <div style="font-size: 10px; font-weight: bold; opacity: 0.9;">COMPRE POR:</div>
                <div id="display-compre"><span>R$</span>00,00</div>
                <div id="display-venda">Venda por: R$ 00,00</div>
                <div id="info-detalhes"><span id="display-sku">00000</span> | <span id="display-nome">PRODUTO</span></div>
            </div>
            <div id="texto-legal"></div>
        </div>
    </div>

    <script>
        let planilha = [];

        document.getElementById('csv-file').addEventListener('change', function(e) {
            Papa.parse(e.target.files[0], {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    planilha = results.data;
                    renderTabela();
                    document.getElementById('step-1').classList.remove('active');
                    document.getElementById('step-2').classList.add('active');
                    atualizarCard(0);
                }
            });
        });

        function renderTabela() {
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            planilha.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['SKU'] || index}</td>
                    <td>
                        <input type="text" class="input-text-url" placeholder="Link" onchange="vincularLink(this.value, ${index})">
                        <input type="file" onchange="carregarArquivo(event, ${index})" style="font-size: 9px;">
                    </td>
                    <td><button onclick="atualizarCard(${index})" style="cursor:pointer">üëÅÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function vincularLink(url, index) { planilha[index].imgData = url; atualizarCard(index); }
        function carregarArquivo(event, index) {
            const reader = new FileReader();
            reader.onload = (e) => { planilha[index].imgData = e.target.result; atualizarCard(index); };
            reader.readAsDataURL(event.target.files[0]);
        }

        function atualizarCard(index) {
            const item = planilha[index];
            document.getElementById('titulo-principal').innerText = item['T√≠tulo Principal'] || '';
            document.getElementById('subtitulo').innerText = item['SUBT√çTULO'] || '';
            let compre = (item['COMPRE POR'] || '0,00').replace('R$', '').trim();
            document.getElementById('display-compre').innerHTML = `<span>R$</span>${compre}`;
            document.getElementById('display-venda').innerText = `Venda por: ${item['VENDA POR'] || 'R$ 0,00'}`;
            document.getElementById('display-sku').innerText = item['SKU'] || '';
            document.getElementById('display-nome').innerText = item['Nome do Produto'] || '';
            document.getElementById('texto-legal').innerText = item['(TEXTO LEGAL) Colocar no rodap√©'] || '';
            
            const img = document.getElementById('produto-img');
            img.src = item.imgData || '';
            img.style.display = item.imgData ? 'block' : 'none';
            aplicarAjustes();
        }

        function aplicarAjustes() {
            const img = document.getElementById('produto-img');
            const zoom = document.getElementById('zoom-img').value;
            const x = document.getElementById('posX-img').value;
            const y = document.getElementById('posY-img').value;
            img.style.transform = `scale(${zoom}) translate(${x}px, ${y}px)`;
            document.getElementById('header-area').style.top = `${document.getElementById('posY-titulo').value}px`;
        }

        async function baixarZip() {
            const zip = new JSZip();
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "GERANDO...";
            btn.disabled = true;

            for (let i = 0; i < planilha.length; i++) {
                atualizarCard(i);
                await new Promise(r => setTimeout(r, 600)); // Espera carregar imagem
                const canvas = await html2canvas(document.getElementById('card-canvas'), { scale: 2, useCORS: true });
                zip.file(`card_${planilha[i].SKU || i}.png`, canvas.toDataURL("image/png").split(',')[1], {base64: true});
            }

            zip.generateAsync({type:"blob"}).then(c => {
                saveAs(c, "cards_boticario_producao.zip");
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
